<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moroccan Youth Athletic Festival - Fall 2025 Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

  <!--
  PayPal is DISABLED for testing. When you're ready to enable payments:
  1) Uncomment the SDK below.
  2) Swap the test button back to startPayPal().
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD"></script>
  -->
  <style>
    body { background: #fafafa; }
    .container.form-wrap { max-width: 860px; }
  </style>
</head>

<body>
<section class="hero is-primary is-bold">
  <div class="hero-body">
    <div class="container">
      <div class="columns is-vcentered">
        <div class="column has-text-centered">
          <h1 class="title">Moroccan Youth Athletic Festival - Fall 2025</h1>
          <h2 class="subtitle is-4">Registration Form</h2>
        </div>
      </div>
    </div>
  </div>
</section>

<form id="form" class="container form-wrap m-4 pl-4" method="POST">
  <h2 class="title is-4 mt-5">Parent Information</h2>
  <div class="field">
    <label class="label">Full Name</label>
    <div class="control">
      <input class="input" type="text" name="Parent Full Name" required>
    </div>
  </div>

  <div class="field">
    <label class="label">Email</label>
    <div class="control">
      <input class="input" type="email" name="Parent Email" required>
    </div>
  </div>

  <div class="field">
    <label class="label">Phone Number</label>
    <div class="control">
      <input class="input" type="tel" name="Parent Phone" required>
    </div>
  </div>

  <h2 class="title is-4 mt-5">Participant Information</h2>
  <div id="participants-container"></div>
  <div class="field">
    <div class="control">
      <button class="button is-info" type="button" onclick="addParticipant()">Add Participant</button>
    </div>
  </div>

  <h2 class="title is-4 mt-5">Waiver & Consent</h2>
  <div class="field">
    <div class="control">
      <textarea class="textarea" readonly>
I, the parent or legal guardian of the participant, give permission for my child to take part in the Moroccan Youth Athletic Festival. I understand that participation in sports involves certain risks of injury and voluntarily assume all such risks. I release MASAR, event organizers, coaches, and volunteers from any liability for injuries or damages that may occur during the event. I authorize emergency medical treatment if needed and accept responsibility for any associated costs. I also give permission for my childâ€™s photos or videos to be used for promotional purposes without compensation. I confirm my child is in good health and able to participate.
      </textarea>
    </div>
  </div>
  <div class="field">
    <div class="control">
      <label class="checkbox">
        <input type="checkbox" name="Waiver Consent" required>
        I have read and agree to the above waiver.
      </label>
    </div>
  </div>

  <div id="total-due" class="notification is-info" style="display:none; font-weight:bold; margin-top:20px;">
    Total Due: $0
  </div>

  <!-- TEST BUTTON (NO PAYMENT) -->
  <div id="proceed-container" class="field mt-5">
    <div class="control">
      <button class="button is-primary" type="button" onclick="submitTest()">Submit (Test without Payment)</button>
    </div>
  </div>

  <!-- PayPal area (hidden while testing). Re-enable later if needed.
  <div id="paypal-button-container" style="display:none;" class="mt-4"></div>
  -->
</form>

<script>
/** ==== CONFIG ==== **/
const PRICE_PER_PARTICIPANT = 20;
// IMPORTANT: Put your current Apps Script Web App deployment URL here:
const FETCH_URL = "https://script.google.com/macros/s/1-4klYPkcyIVXnFJRACD7tro_jeM-zPy9pnBS9i4A38fbUE7jy2Ums0pi/exec";
// Toggle this to true while testing to let your Apps Script skip emails if you gate on TEST_MODE.
const TEST_MODE = true;
/** ================ **/

function updateTotalAmount() {
  const participantCount = document.querySelectorAll('#participants-container .box').length;
  const totalDueDiv = document.getElementById('total-due');
  if (participantCount > 0) {
    totalDueDiv.style.display = 'block';
    totalDueDiv.textContent = `Total Due: $${participantCount * PRICE_PER_PARTICIPANT}`;
  } else {
    totalDueDiv.style.display = 'none';
  }
}

function addParticipant() {
  const container = document.getElementById('participants-container');
  const id = `participant-${Date.now()}`;
  const index = container.children.length;
  container.insertAdjacentHTML('beforeend', `
    <div class="box mt-4" id="${id}">
      <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
        <h3 class="title is-5">Participant ${index + 1}</h3>
        <button type="button" class="delete" aria-label="Remove participant" onclick="removeParticipant('${id}')"></button>
      </div>

      <div class="field">
        <label class="label">First Name</label>
        <div class="control">
          <input class="input" type="text" name="Participant First Name[]" required>
        </div>
      </div>

      <div class="field">
        <label class="label">Last Name</label>
        <div class="control">
          <input class="input" type="text" name="Participant Last Name[]" required>
        </div>
      </div>

      <div class="field">
        <label class="label">Date of Birth</label>
        <div class="control">
          <input class="input" type="date" name="Participant DOB[]" required>
        </div>
      </div>

      <div class="field">
        <label class="label">Gender</label>
        <div class="control">
          <label class="radio">
            <input type="radio" name="Participant Gender[${index}]" value="boy" required onchange="toggleSoccerLevel('${id}', true)"> Boy (Soccer)
          </label>
          <label class="radio">
            <input type="radio" name="Participant Gender[${index}]" value="girl" onchange="toggleSoccerLevel('${id}', false)"> Girl (Race)
          </label>
        </div>
      </div>

      <div class="field soccer-level" id="soccer-${id}">
        <label class="label">Soccer Level</label>
        <div class="control">
          <div class="select">
            <select name="Soccer Level[]">
              <option value="recreational">Recreational</option>
              <option value="travel">Travel</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  `);
  updateTotalAmount();
}

function removeParticipant(id) {
  const box = document.getElementById(id);
  if (box) box.remove();
  updateTotalAmount();
}

function toggleSoccerLevel(participantId, show) {
  const el = document.getElementById(`soccer-${participantId}`);
  if (el) {
    el.style.display = show ? 'block' : 'none';
    const select = el.querySelector('select');
    if (!show && select) select.value = "";
  }
}

/** ====== TEST SUBMIT (NO PAYPAL) ====== **/
function submitTest() {
  // Same validation used in payment flow, but we post immediately
  const parentName = document.querySelector('input[name="Parent Full Name"]').value.trim();
  const parentEmail = document.querySelector('input[name="Parent Email"]').value.trim();
  const parentPhone = document.querySelector('input[name="Parent Phone"]').value.trim();
  const waiverConsent = document.querySelector('input[name="Waiver Consent"]:checked');
  const participantBoxes = document.querySelectorAll('#participants-container .box');

  if (!parentName || !parentEmail || !parentPhone || !waiverConsent || participantBoxes.length === 0) {
    alert("Please complete all Parent Information, add at least one Participant, and agree to Waiver.");
    return;
  }

  for (let box of participantBoxes) {
    const firstName = box.querySelector('input[name="Participant First Name[]"]').value.trim();
    const lastName  = box.querySelector('input[name="Participant Last Name[]"]').value.trim();
    const dob       = box.querySelector('input[name="Participant DOB[]"]').value.trim();
    const genderSel = box.querySelector('input[type="radio"]:checked');
    if (!firstName || !lastName || !dob || !genderSel) {
      alert("Please fill out all fields for every participant.");
      return;
    }
  }

  // Post directly (no PayPal)
  sendFormData();
}

/** ====== SEND TO APPS SCRIPT ====== **/
function sendFormData() {
  const form = document.getElementById('form');
  const formData = new FormData(form);

  // Normalize genders into an array key the server expects
  const genderInputs = document.querySelectorAll('input[type="radio"][name^="Participant Gender"]:checked');
  genderInputs.forEach(radio => {
    formData.append("Participant Gender[]", radio.value);
  });

  // Add a testing flag so your Apps Script can optionally skip emailing
  if (TEST_MODE) {
    formData.append("TEST_MODE", "true");
  }

  // Build x-www-form-urlencoded body
  const pairs = [];
  for (const [k, v] of formData.entries()) {
    pairs.push(`${encodeURIComponent(k)}=${encodeURIComponent(v)}`);
  }
  const body = pairs.join("&");

  fetch(FETCH_URL, {
    method: "POST",
    body,
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" }
  })
  .then(res => {
    if (!res.ok) throw new Error("Bad response");
    return res.text();
  })
  .then(() => {
    // Redirect after success
    window.location.href = "thank-you.html";
  })
  .catch(err => {
    console.error("Form submit error:", err);
    alert("There was a problem submitting your registration.");
  });
}

/** ===== INIT ===== **/
document.addEventListener('DOMContentLoaded', () => {
  // Start with one participant by default (optional)
  addParticipant();
  updateTotalAmount();
});

/** ===== OPTIONAL: PAYPAL (commented out) =====
function startPayPal() {
  // ... your existing PayPal flow ...
  // On approve: sendFormData();
}
================================================ */
</script>
</body>
</html>
